name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # =============================================================================
  # Stage 1: Fast Checks (lint, format, typecheck) - Run in parallel
  # =============================================================================

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Biome
        run: pnpm lint

  typecheck:
    name: TypeCheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run TypeScript
        run: pnpm typecheck

  # =============================================================================
  # Stage 2: Unit Tests - Run after lint/format pass
  # =============================================================================

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [lint, typecheck]
    if: |
      always() &&
      (needs.lint.result == 'success' || needs.lint.result == 'skipped') &&
      (needs.typecheck.result == 'success' || needs.typecheck.result == 'skipped')
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests
        run: pnpm test -- --run

  # =============================================================================
  # Stage 3: Build - Run after tests pass
  # =============================================================================

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [test]
    if: |
      always() &&
      (needs.test.result == 'success' || needs.test.result == 'skipped')
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist
          retention-days: 7

  # =============================================================================
  # Stage 4: Integration Tests - Run after build
  # =============================================================================

  sentry-integration:
    name: Sentry Integration Tests
    runs-on: ubuntu-latest
    needs: [build]
    # Run Sentry tests, but gracefully skip if secrets not available
    if: |
      always() &&
      needs.build.result == 'success'
    steps:
      - uses: actions/checkout@v4

      - name: Check Sentry secrets available
        id: check-secrets
        run: |
          if [[ -n "${{ secrets.SENTRY_AUTH_TOKEN }}" ]]; then
            echo "available=true" >> $GITHUB_OUTPUT
          else
            echo "available=false" >> $GITHUB_OUTPUT
            echo "::notice::Sentry secrets not configured. Skipping Sentry integration tests."
          fi

      - uses: pnpm/action-setup@v4
        if: steps.check-secrets.outputs.available == 'true'

      - uses: actions/setup-node@v4
        if: steps.check-secrets.outputs.available == 'true'
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Test Sentry Integration
        if: steps.check-secrets.outputs.available == 'true'
        env:
          SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
          SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
          SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
          VITE_SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
        run: |
          TEST_ID="ci-${{ github.run_id }}"

          # Install dependencies and Playwright
          pnpm install --frozen-lockfile
          npx playwright install chromium

          # Start dev server in background
          pnpm dev &
          DEV_PID=$!

          # Wait for dev server
          for i in {1..30}; do
            if curl -s http://localhost:5173 > /dev/null 2>&1; then
              echo "Dev server ready"
              break
            fi
            echo "Waiting for dev server... ($i/30)"
            sleep 2
          done

          # Run Sentry integration test
          PLAYWRIGHT_SKIP_WEBSERVER=true PLAYWRIGHT_BASE_URL=http://localhost:5173 TEST_ID="$TEST_ID" npx playwright test e2e/sentry-integration.spec.ts --project=chromium || true

          # Cleanup
          kill $DEV_PID 2>/dev/null || true

  # =============================================================================
  # Stage 5: E2E / Smoke Tests - Run after builds pass
  # =============================================================================

  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [build]
    if: |
      always() &&
      needs.build.result == 'success'
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run E2E smoke tests
        # Exclude sentry/posthog integration tests (require dev server, not preview build)
        run: npx playwright test --project=chromium --ignore-snapshots --grep-invert "sentry|posthog"
        env:
          CI: true
          PLAYWRIGHT_BASE_URL: http://localhost:4173

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: playwright-report
          retention-days: 7

  # =============================================================================
  # Final Status Check - Aggregates all job statuses
  # =============================================================================

  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [build, e2e, sentry-integration]
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          # Check if a job result is acceptable (success or skipped)
          check_job() {
            local result="$1"
            [[ "$result" == "success" || "$result" == "skipped" ]]
          }

          echo "Job results:"
          echo "  build: ${{ needs.build.result }}"
          echo "  e2e: ${{ needs.e2e.result }}"
          echo "  sentry-integration: ${{ needs.sentry-integration.result }}"

          failed=0

          if ! check_job "${{ needs.build.result }}"; then
            echo "::error::build failed with: ${{ needs.build.result }}"
            failed=1
          fi

          if ! check_job "${{ needs.e2e.result }}"; then
            echo "::error::e2e failed with: ${{ needs.e2e.result }}"
            failed=1
          fi

          if ! check_job "${{ needs.sentry-integration.result }}"; then
            echo "::error::sentry-integration failed with: ${{ needs.sentry-integration.result }}"
            failed=1
          fi

          if [[ $failed -eq 1 ]]; then
            echo "One or more jobs failed"
            exit 1
          fi

          echo "All CI checks passed!"
